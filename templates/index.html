<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>H3C äº¤æ¢æœºé…ç½®åŠ©æ‰‹ (ç¦»çº¿ç‰ˆ)</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-box { background: #212529; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 300px; overflow-y: auto; font-size: 0.9rem;}
        .status-deny { color: #dc3545; font-weight: bold; }
        .status-permit { color: #198754; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center mb-4">H3C S5130S é…ç½®ç®¡ç†ç³»ç»Ÿ</h2>

    <div class="card p-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label text-muted">IP åœ°å€</label>
                <input type="text" class="form-control" id="sw_ip" value="10.139.100.203">
            </div>
            <div class="col-md-2">
                <label class="form-label text-muted">ç«¯å£</label>
                <input type="number" class="form-control" id="sw_port" value="22">
            </div>
            <div class="col-md-2">
                <label class="form-label text-muted">ç”¨æˆ·å</label>
                <input type="text" class="form-control" id="sw_user" value="admin">
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted">å¯†ç </label>
                <input type="password" class="form-control" id="sw_pass">
            </div>
            <div class="col-md-2">
                <button class="btn btn-info text-white w-100 fw-bold" onclick="testConnection()">
                    ğŸ”Œ è¿æ¥æµ‹è¯•
                </button>
            </div>
            
            <div class="col-md-12 text-end mt-3 border-top pt-3">
                <span class="text-muted me-2" style="font-size: 0.9rem;">æ“ä½œå®Œæˆåï¼Œè¯·è®°å¾—ä¿å­˜é…ç½®ä»¥å…ä¸¢å¤±:</span>
                <button class="btn btn-warning fw-bold" onclick="saveConfig()">
                    ğŸ’¾ ä¿å­˜å½“å‰é…ç½® (Write)
                </button>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="acl-tab-btn" data-bs-toggle="tab" data-bs-target="#acl-tab-pane" type="button" role="tab">ACL MAC 4000 ç®¡ç†</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="port-tab-btn" data-bs-toggle="tab" data-bs-target="#port-tab-pane" type="button" role="tab">ç«¯å£ IP+MAC ç»‘å®š</button>
        </li>
    </ul>

    <div class="tab-content p-3 border border-top-0 bg-white" id="myTabContent">
        
        <div class="tab-pane fade show active" id="acl-tab-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <h5>æ·»åŠ è§„åˆ™</h5>
                    <div class="alert alert-info py-2" style="font-size: 0.9rem;">
                        æç¤º: æ–°è§„åˆ™è¯·æŒ‡å®šå°äº 999 çš„ ID ä»¥ç¡®ä¿ç”Ÿæ•ˆã€‚
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">ID</span>
                        <input type="number" class="form-control" id="acl_id" placeholder="ä¾‹å¦‚: 12">
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">MAC</span>
                        <input type="text" class="form-control" id="acl_mac" placeholder="aaaa-bbbb-cccc">
                        <button class="btn btn-primary" onclick="addAcl()">æ·»åŠ ç™½åå•</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <h5>è§„åˆ™åˆ—è¡¨ <button class="btn btn-sm btn-outline-secondary" onclick="loadAcl()">åˆ·æ–°</button></h5>
                    <table class="table table-striped table-hover">
                        <thead><tr><th>Rule ID</th><th>åŠ¨ä½œ</th><th>MAC åœ°å€</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="acl_table_body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="port-tab-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-12 mb-4">
                    <h5>ç«¯å£é…ç½® (ä¸€æ­¥æ³•: VLAN + STP + Verify + Binding)</h5>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">ç«¯å£é€‰æ‹©</label>
                            <div class="input-group">
                                <select class="form-select" id="port_name">
                                    <option value="" selected>è¯·å…ˆç‚¹å‡»å³ä¾§åˆ·æ–°...</option>
                                </select>
                                <button class="btn btn-secondary" onclick="getInterfaces()" title="ä»äº¤æ¢æœºè·å–ç«¯å£åˆ—è¡¨">ğŸ”„ è·å–ç«¯å£</button>
                                <button class="btn btn-info text-white" onclick="queryPort()" title="æŸ¥è¯¢é€‰ä¸­ç«¯å£çš„é…ç½®">ğŸ” æŸ¥è¯¢é…ç½®</button>
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label">VLAN ID</label>
                            <input type="text" class="form-control" id="vlan_id" placeholder="202">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ç»‘å®š IP</label>
                            <input type="text" class="form-control" id="bind_ip" placeholder="IP åœ°å€">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ç»‘å®š MAC</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="bind_mac" placeholder="MAC åœ°å€">
                                <button class="btn btn-success" onclick="applyPort()">æ·»åŠ ç»‘å®š</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <h5>è¯¥ç«¯å£ä¸‹çš„å·²ç»‘å®šè®¾å¤‡åˆ—è¡¨</h5>
                    <table class="table table-bordered table-striped">
                        <thead class="table-light"><tr><th>IP åœ°å€</th><th>MAC åœ°å€</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="bind_table_body">
                            <tr><td colspan="3" class="text-center text-muted">è¯·å…ˆé€‰æ‹©ç«¯å£å¹¶ç‚¹å‡»â€œæŸ¥è¯¢â€...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h5>æ“ä½œæ—¥å¿—</h5>
        <div id="log_area" class="log-box">ç­‰å¾…æ“ä½œ...</div>
    </div>
</div>

<script src="/static/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof bootstrap === 'undefined') {
            alert("âš ï¸ ä¸¥é‡é”™è¯¯ï¼šæ— æ³•åŠ è½½æœ¬åœ° Bootstrap JS æ–‡ä»¶ï¼\n\nTab åˆ‡æ¢åŠŸèƒ½å°†å¤±æ•ˆã€‚\nè¯·æ£€æŸ¥ static/js/bootstrap.bundle.min.js æ˜¯å¦å­˜åœ¨ã€‚");
        }
    });

    async function apiCall(endpoint, data) {
        const ip = document.getElementById('sw_ip').value;
        const port = document.getElementById('sw_port').value || 22;
        const user = document.getElementById('sw_user').value;
        const pass = document.getElementById('sw_pass').value;
        if(!ip || !pass) { alert("è¯·è¾“å…¥äº¤æ¢æœº IP å’Œå¯†ç "); return; }
        document.getElementById('log_area').innerHTML = "æ­£åœ¨æ‰§è¡Œï¼Œè¯·ç¨å€™...<br>";
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ip, port, user, pass, ...data})
            });
            const result = await response.json();
            document.getElementById('log_area').innerHTML += result.log || result.msg;
            if(result.status === 'error') alert("é”™è¯¯: " + result.msg);
            return result;
        } catch (error) {
            alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åå°");
        }
    }

    async function testConnection() { await apiCall('/test_connection', {}); }

// === è·å–æ¥å£åˆ—è¡¨å‡½æ•° (å‡çº§ç‰ˆï¼šæ”¯æŒæ˜¾ç¤ºæè¿°) ===
    async function getInterfaces() {
        const select = document.getElementById('port_name');
        
        // è®°å½•å½“å‰é€‰ä¸­çš„å€¼ï¼Œä»¥ä¾¿åˆ·æ–°åå¦‚æœè¿˜åœ¨åˆ—è¡¨é‡Œï¼Œä¿æŒé€‰ä¸­
        const currentVal = select.value;
        
        select.innerHTML = '<option>åŠ è½½ä¸­...</option>';
        
        const res = await apiCall('/get_interfaces', {});
        if(res && res.status === 'success') {
            select.innerHTML = ''; // æ¸…ç©º
            
            if(res.data.length === 0) {
                select.innerHTML = '<option value="">æœªæ‰¾åˆ°ç‰©ç†æ¥å£</option>';
            } else {
                // å¡«å……ä¸‹æ‹‰æ¡†
                res.data.forEach(item => {
                    const option = document.createElement('option');
                    
                    // è¿™é‡Œæ˜¯å…³é”®ï¼š
                    // option.value ä¼ ç»™åç«¯ (GigabitEthernet1/0/1)
                    // option.text æ˜¾ç¤ºç»™ç”¨æˆ· (GigabitEthernet1/0/1 (æŸæŸåŠå…¬å®¤))
                    option.value = item.value; 
                    option.text = item.text;
                    
                    select.appendChild(option);
                });
                
                // å°è¯•æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                if (currentVal) {
                    select.value = currentVal;
                }
                if (!select.value && res.data.length > 0) {
                    select.value = res.data[0].value;
                }
            }
        } else {
            select.innerHTML = '<option value="">è·å–å¤±è´¥</option>';
        }
    }

    async function loadAcl() {
        const res = await apiCall('/get_acl', {});
        if(res && res.status === 'success') {
            const tbody = document.getElementById('acl_table_body');
            tbody.innerHTML = '';
            res.data.forEach(rule => {
                const actionClass = rule.action.toLowerCase() === 'deny' ? 'status-deny' : 'status-permit';
                tbody.innerHTML += `<tr>
                    <td>${rule.id}</td>
                    <td class="${actionClass}">${rule.action}</td>
                    <td>${rule.mac}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="delAcl(${rule.id})">åˆ é™¤</button></td>
                </tr>`;
            });
        }
    }
    async function addAcl() {
        const mac = document.getElementById('acl_mac').value;
        const rule_id = document.getElementById('acl_id').value;
        if(!mac) return alert("è¯·è¾“å…¥ MAC");
        await apiCall('/add_acl', {mac, rule_id});
        loadAcl();
    }
    async function delAcl(id) {
        if(confirm("ç¡®å®šåˆ é™¤ Rule " + id + " å—ï¼Ÿ")) {
            await apiCall('/del_acl', {rule_id: id});
            loadAcl(); 
        }
    }
    async function queryPort() {
        const port = document.getElementById('port_name').value;
        if(!port || port.includes("åŠ è½½ä¸­") || port.includes("è¯·å…ˆ")) return alert("è¯·å…ˆè·å–å¹¶é€‰æ‹©ä¸€ä¸ªç«¯å£");
        
        const res = await apiCall('/get_port_info', {interface: port});
        if(res && res.status === 'success') {
            if(res.data.vlan) document.getElementById('vlan_id').value = res.data.vlan;
            const tbody = document.getElementById('bind_table_body');
            tbody.innerHTML = '';
            if(res.data.bindings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">å½“å‰ç«¯å£æ— ç»‘å®šä¿¡æ¯</td></tr>';
            } else {
                res.data.bindings.forEach(bind => {
                    tbody.innerHTML += `<tr><td>${bind.ip}</td><td>${bind.mac}</td><td><button class="btn btn-danger btn-sm" onclick="delBinding('${bind.ip}', '${bind.mac}')">è§£ç»‘</button></td></tr>`;
                });
            }
        }
    }
    async function applyPort() {
        const port = document.getElementById('port_name').value;
        const vlan = document.getElementById('vlan_id').value;
        const ip = document.getElementById('bind_ip').value;
        const mac = document.getElementById('bind_mac').value;
        if(!port) return alert("è¯·é€‰æ‹©ç«¯å£");
        if(!vlan || !ip || !mac) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        await apiCall('/bind_port', {interface: port, vlan, bind_ip: ip, mac});
        queryPort(); 
    }
    async function delBinding(ip, mac) {
        const port = document.getElementById('port_name').value;
        if(!confirm(`ç¡®å®šè¦è§£é™¤ç«¯å£ ${port} ä¸Š ${ip} - ${mac} çš„ç»‘å®šå—ï¼Ÿ`)) return;
        await apiCall('/del_port_binding', {interface: port, del_ip: ip, del_mac: mac});
        queryPort(); 
    }
    async function saveConfig() {
        if(!confirm("ç¡®å®šè¦æ‰§è¡Œ save å‘½ä»¤ä¿å­˜å½“å‰é…ç½®å—ï¼Ÿ")) return;
        await apiCall('/save_config', {});
        alert("ä¿å­˜å‘½ä»¤å·²å‘é€ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—åŒºç¡®è®¤ç»“æœã€‚");
    }
</script>
</body>
</html>