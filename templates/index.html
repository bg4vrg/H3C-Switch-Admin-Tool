<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>H3C äº¤æ¢æœºé…ç½®åŠ©æ‰‹ (èµ„äº§ç‰ˆ)</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-box { 
            background: #212529; 
            color: #0f0; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            max-height: 300px; 
            overflow-y: auto; 
            font-size: 0.9rem;
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .status-deny { color: #dc3545; font-weight: bold; }
        .status-permit { color: #198754; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <h3>ğŸ›¡ï¸ H3C S5130S é…ç½®ç®¡ç†ç³»ç»Ÿ</h3>
        <div>
            <span class="me-2 text-muted">ğŸ‘¤ {{ username }}</span>
            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#pwdModal">ä¿®æ”¹å¯†ç </button>
            <a href="/logout" class="btn btn-danger btn-sm">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <div class="card p-4 border-primary">
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <h5 class="card-title m-0">ğŸ“¡ è®¾å¤‡è¿æ¥ä¸ç®¡ç†</h5>
            <div>
                <button class="btn btn-success btn-sm me-2" onclick="batchBackup()">ğŸ“¥ ä¸€é”®æ‰¹é‡å¤‡ä»½</button>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#manageModal">âš™ï¸ ç®¡ç†è®¾å¤‡åˆ—è¡¨</button>
            </div>
        </div>
        
        <div class="row g-3 mb-3 bg-light p-3 rounded mx-0">
            <div class="col-md-12">
                <label class="form-label fw-bold">ğŸ“‚ å¿«æ·è¿æ¥ (é€‰æ‹©åè‡ªåŠ¨å¡«å……)ï¼š</label>
                <select class="form-select" id="saved_switches" onchange="fillSwitchInfo()">
                    <option value="">-- è¯·é€‰æ‹©è®¾å¤‡æˆ–æ‰‹åŠ¨è¾“å…¥ --</option>
                </select>
            </div>
        </div>

        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label text-muted">IP åœ°å€</label>
                <input type="text" class="form-control" id="sw_ip" placeholder="192.168.x.x">
            </div>
            <div class="col-md-2">
                <label class="form-label text-muted">ç«¯å£</label>
                <input type="number" class="form-control" id="sw_port" value="22">
            </div>
            <div class="col-md-2">
                <label class="form-label text-muted">ç”¨æˆ·å</label>
                <input type="text" class="form-control" id="sw_user" value="admin">
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted">å¯†ç </label>
                <input type="password" class="form-control" id="sw_pass" placeholder="å¦‚æœ‰ä¿å­˜è‡ªåŠ¨å¡«å……">
            </div>
            <div class="col-md-2">
                <button class="btn btn-info text-white w-100 fw-bold" onclick="testConnection()">ğŸ”Œ è¿æ¥æµ‹è¯•</button>
            </div>
            
            <div class="col-md-12 text-end mt-3 border-top pt-3">
                <span class="text-muted me-2" style="font-size: 0.9rem;">æ“ä½œå®Œæˆåï¼Œè¯·è®°å¾—ä¿å­˜é…ç½®:</span>
                <button class="btn btn-warning fw-bold" onclick="saveConfig()">ğŸ’¾ ä¿å­˜å½“å‰é…ç½® (Write)</button>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="acl-tab-btn" data-bs-toggle="tab" data-bs-target="#acl-tab-pane" type="button" role="tab">ACL MAC 4000 ç®¡ç†</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="port-tab-btn" data-bs-toggle="tab" data-bs-target="#port-tab-pane" type="button" role="tab">ç«¯å£ IP+MAC ç»‘å®š</button></li>
    </ul>

    <div class="tab-content p-3 border border-top-0 bg-white shadow-sm" id="myTabContent" style="min-height: 300px;">
        <div class="tab-pane fade show active" id="acl-tab-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <h5>æ·»åŠ è§„åˆ™</h5>
                    <div class="alert alert-info py-2" style="font-size: 0.9rem;">æç¤º: æ–°è§„åˆ™è¯·æŒ‡å®šå°äº 999 çš„ IDã€‚</div>
                    <div class="input-group mb-3"><span class="input-group-text">ID</span><input type="number" class="form-control" id="acl_id" placeholder="12"></div>
                    <div class="input-group mb-3"><span class="input-group-text">MAC</span><input type="text" class="form-control" id="acl_mac" placeholder="aaaa-bbbb-cccc"><button class="btn btn-primary" onclick="addAcl()">æ·»åŠ </button></div>
                </div>
                <div class="col-md-7 border-start">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>è§„åˆ™åˆ—è¡¨</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadAcl()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <table class="table table-striped table-hover table-sm">
                        <thead><tr><th>Rule ID</th><th>åŠ¨ä½œ</th><th>MAC</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="acl_table_body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="port-tab-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-12 mb-4">
                    <h5>ç«¯å£é…ç½® (ä¸€æ­¥æ³•: VLAN + STP + Verify + Binding)</h5>
                    <div class="row g-3 align-items-end bg-light p-3 rounded border">
                        <div class="col-md-4">
                            <label class="form-label">ç«¯å£é€‰æ‹©</label>
                            <div class="input-group">
                                <select class="form-select" id="port_name"><option value="" selected>è¯·å…ˆç‚¹å‡»å³ä¾§åˆ·æ–°...</option></select>
                                <button class="btn btn-secondary" onclick="getInterfaces()">ğŸ”„ è·å–</button>
                                <button class="btn btn-info text-white" onclick="queryPort()">ğŸ” æŸ¥è¯¢</button>
                            </div>
                        </div>
                        <div class="col-md-2"><label class="form-label">VLAN ID</label><input type="text" class="form-control" id="vlan_id" placeholder="202"></div>
                        <div class="col-md-3"><label class="form-label">ç»‘å®š IP</label><input type="text" class="form-control" id="bind_ip" placeholder="IP"></div>
                        <div class="col-md-3"><label class="form-label">ç»‘å®š MAC</label><div class="input-group"><input type="text" class="form-control" id="bind_mac" placeholder="MAC"><button class="btn btn-success" onclick="applyPort()">ç»‘å®š</button></div></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <h5>å·²ç»‘å®šè®¾å¤‡åˆ—è¡¨</h5>
                    <table class="table table-bordered table-striped">
                        <thead class="table-light"><tr><th>IP</th><th>MAC</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="bind_table_body"><tr><td colspan="3" class="text-center text-muted">è¯·å…ˆæŸ¥è¯¢ç«¯å£ä¿¡æ¯...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h5>ğŸ“ æ“ä½œæ—¥å¿—</h5>
        <div id="log_area" class="log-box">ç­‰å¾…æ“ä½œ...</div>
    </div>
</div>

<div class="modal fade" id="manageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ç®¡ç†è®¾å¤‡åˆ—è¡¨</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="card bg-light p-3 mb-3 border-0">
                    <h6 class="card-subtitle mb-2 text-primary fw-bold">æ·»åŠ æ–°è®¾å¤‡</h6>
                    <div class="row g-2 mb-2">
                        <div class="col-md-4"><input type="text" class="form-control form-control-sm" id="new_name" placeholder="å¤‡æ³¨åç§°"></div>
                        <div class="col-md-5"><input type="text" class="form-control form-control-sm" id="new_ip" placeholder="IP åœ°å€"></div>
                        <div class="col-md-3"><div class="input-group input-group-sm"><span class="input-group-text">ç«¯å£</span><input type="number" class="form-control" id="new_port" value="22" placeholder="22"></div></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-5"><input type="text" class="form-control form-control-sm" id="new_user" value="admin" placeholder="ç”¨æˆ·å"></div>
                        <div class="col-md-5"><input type="password" class="form-control form-control-sm" id="new_pass" placeholder="å¯†ç "></div>
                        <div class="col-md-2"><button class="btn btn-primary btn-sm w-100" onclick="addSwitch()">â• æ·»åŠ </button></div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle text-center">
                        <thead class="table-light"><tr><th>å¤‡æ³¨å</th><th>åœ°å€ (IP:Port)</th><th>ç”¨æˆ·å</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="switch_list_body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="pwdModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ä¿®æ”¹ Web ç™»å½•å¯†ç </h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label">è®¾ç½®æ–°å¯†ç </label><input type="password" class="form-control" id="new_sys_pass" placeholder="è¯·è¾“å…¥æ–°å¯†ç "></div>
                <button class="btn btn-success w-100" onclick="changeSysPass()">ç¡®è®¤ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof bootstrap === 'undefined') alert("æ— æ³•åŠ è½½æœ¬åœ° Bootstrap JSï¼è¯·æ£€æŸ¥ static ç›®å½•ã€‚");
        loadSwitches(); 
    });

    let switchData = []; 

    // é€šç”¨ API è¯·æ±‚
    async function apiCall(endpoint, data) {
        let payload = {};
        const device_actions = ['/test_connection', '/get_interfaces', '/get_port_info', '/bind_port', '/del_port_binding', '/save_config', '/get_acl', '/add_acl', '/del_acl'];

        if (device_actions.includes(endpoint)) {
            const ip = document.getElementById('sw_ip').value;
            const port = document.getElementById('sw_port').value || 22;
            const user = document.getElementById('sw_user').value;
            const pass = document.getElementById('sw_pass').value;
            if(!ip || !pass) { alert("è¯·å…ˆå¡«å†™äº¤æ¢æœºè¿æ¥ä¿¡æ¯ï¼ˆIP å’Œ å¯†ç ï¼‰"); return null; }
            payload = {ip, port, user, pass, ...data};
        } else {
            payload = data;
        }

        document.getElementById('log_area').innerHTML = "â³ æ­£åœ¨æ‰§è¡Œï¼Œè¯·ç¨å€™...<br>";
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (response.redirected) { window.location.href = response.url; return null; }
            const result = await response.json();
            if(result.log) document.getElementById('log_area').innerHTML = result.log;
            else if (result.status === 'success') document.getElementById('log_area').innerHTML = "âœ… æ“ä½œæˆåŠŸ";
            if(result.status === 'error') {
                alert("âŒ é”™è¯¯: " + result.msg);
                document.getElementById('log_area').innerHTML += `<br><span class="status-deny">âŒ å¤±è´¥: ${result.msg}</span>`;
            }
            return result;
        } catch (error) {
            console.error(error);
            document.getElementById('log_area').innerHTML = "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥";
            return null;
        }
    }

    // === ğŸ”¥ æ–°å¢ï¼šæ‰¹é‡å¤‡ä»½ JS é€»è¾‘ ===
    async function batchBackup() {
        if(switchData.length === 0) return alert("è¯·å…ˆåœ¨â€˜ç®¡ç†è®¾å¤‡åˆ—è¡¨â€™ä¸­æ·»åŠ äº¤æ¢æœºï¼");
        if(!confirm(`å³å°†å¯¹ ${switchData.length} å°è®¾å¤‡æ‰§è¡Œé…ç½®å¤‡ä»½ã€‚\nè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚\nç¡®å®šç»§ç»­å—ï¼Ÿ`)) return;
        
        // è¿™é‡Œçš„è¯·æ±‚ä¸éœ€è¦å¸¦ ip/pass å‚æ•°ï¼Œå› ä¸ºåç«¯ä¼šç›´æ¥ä»æ•°æ®åº“è¯»
        await apiCall('/batch_backup', {});
    }

    // === èµ„äº§ç®¡ç† ===
    async function loadSwitches() {
        const response = await fetch('/api/switches');
        if (response.redirected) { window.location.href = response.url; return; }
        const result = await response.json();
        switchData = result.data;
        const select = document.getElementById('saved_switches');
        const tbody = document.getElementById('switch_list_body');
        
        select.innerHTML = '<option value="">-- è¯·é€‰æ‹©è®¾å¤‡æˆ–æ‰‹åŠ¨è¾“å…¥ --</option>';
        switchData.forEach((sw, index) => {
            select.innerHTML += `<option value="${index}">[${sw.name}] ${sw.ip}</option>`;
        });
        
        tbody.innerHTML = '';
        switchData.forEach(sw => {
            tbody.innerHTML += `<tr><td>${sw.name}</td><td>${sw.ip}:${sw.port}</td><td>${sw.username}</td><td><button class="btn btn-danger btn-sm" onclick="delSwitch(${sw.id})">åˆ é™¤</button></td></tr>`;
        });
    }

    function fillSwitchInfo() {
        const index = document.getElementById('saved_switches').value;
        if (index === "") return;
        const sw = switchData[index];
        document.getElementById('sw_ip').value = sw.ip;
        document.getElementById('sw_port').value = sw.port;
        document.getElementById('sw_user').value = sw.username;
        document.getElementById('sw_pass').value = sw.password;
    }

    async function addSwitch() {
        const d = {
            name: document.getElementById('new_name').value,
            ip: document.getElementById('new_ip').value,
            port: document.getElementById('new_port').value,
            user: document.getElementById('new_user').value,
            pass: document.getElementById('new_pass').value
        };
        if(!d.ip || !d.pass) return alert("IP å’Œ å¯†ç å¿…å¡«");
        const res = await apiCall('/api/switches/add', d);
        if (res && res.status === 'success') {
            loadSwitches();
            document.getElementById('new_name').value = '';
            document.getElementById('new_ip').value = '';
            document.getElementById('new_pass').value = '';
        }
    }

    async function delSwitch(id) {
        if(!confirm("ç¡®å®šåˆ é™¤è¯¥è®¾å¤‡è®°å½•å—ï¼Ÿ")) return;
        const res = await apiCall('/api/switches/delete', {id});
        if (res && res.status === 'success') loadSwitches();
    }

    async function changeSysPass() {
        const p = document.getElementById('new_sys_pass').value;
        if(!p) return alert("å¯†ç ä¸èƒ½ä¸ºç©º");
        const res = await apiCall('/api/change_password', {new_password: p});
        if(res && res.status === 'success') { alert("å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•"); location.href = '/logout'; }
    }

    // === ä¸šåŠ¡æ“ä½œ (ä¿æŒä¸å˜) ===
    async function testConnection() { await apiCall('/test_connection', {}); }
    async function getInterfaces() {
        const select = document.getElementById('port_name');
        select.innerHTML = '<option>â³ åŠ è½½ä¸­...</option>';
        const res = await apiCall('/get_interfaces', {});
        select.innerHTML = ''; 
        if(res && res.status === 'success') {
            if(res.data.length === 0) select.innerHTML = '<option value="">âš ï¸ æœªæ‰¾åˆ°ç‰©ç†æ¥å£</option>'; 
            else {
                res.data.forEach(item => select.innerHTML += `<option value="${item.value}">${item.text}</option>`);
                if (select.options.length > 0) select.value = select.options[0].value;
            }
        } else select.innerHTML = '<option value="">âŒ è·å–å¤±è´¥</option>'; 
    }
    async function queryPort() {
        const port = document.getElementById('port_name').value;
        if(!port) return alert("è¯·å…ˆè·å–å¹¶é€‰æ‹©ç«¯å£");
        const res = await apiCall('/get_port_info', {interface: port});
        if(res && res.status === 'success') {
            if(res.data.vlan) document.getElementById('vlan_id').value = res.data.vlan;
            const tbody = document.getElementById('bind_table_body'); tbody.innerHTML = '';
            if(res.data.bindings.length === 0) tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">è¯¥ç«¯å£å½“å‰æ—  IP Source Guard ç»‘å®š</td></tr>';
            else res.data.bindings.forEach(bind => { tbody.innerHTML += `<tr><td>${bind.ip}</td><td>${bind.mac}</td><td><button class="btn btn-danger btn-sm" onclick="delBinding('${bind.ip}', '${bind.mac}')">è§£ç»‘</button></td></tr>`; });
        }
    }
    async function applyPort() {
        const d = { interface: document.getElementById('port_name').value, vlan: document.getElementById('vlan_id').value, bind_ip: document.getElementById('bind_ip').value, mac: document.getElementById('bind_mac').value };
        if(!d.interface || !d.vlan || !d.bind_ip || !d.mac) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        await apiCall('/bind_port', d); queryPort();
    }
    async function delBinding(ip, mac) {
        if(!confirm(`ç¡®å®šè§£ç»‘ IP: ${ip} å—ï¼Ÿ`)) return;
        await apiCall('/del_port_binding', { interface: document.getElementById('port_name').value, del_ip: ip, del_mac: mac }); queryPort();
    }
    async function saveConfig() { if(!confirm("ç¡®å®šè¦æ‰§è¡Œ save force å—ï¼Ÿ")) return; await apiCall('/save_config', {}); alert("ä¿å­˜æŒ‡ä»¤å·²å‘é€"); }
    async function loadAcl() {
        const res = await apiCall('/get_acl', {});
        if(res && res.status === 'success') {
            const tbody = document.getElementById('acl_table_body'); tbody.innerHTML = '';
            res.data.forEach(rule => { tbody.innerHTML += `<tr><td>${rule.id}</td><td>${rule.action}</td><td>${rule.mac}</td><td><button class="btn btn-danger btn-sm" onclick="delAcl(${rule.id})">åˆ é™¤</button></td></tr>`; });
        }
    }
    async function addAcl() {
        const mac = document.getElementById('acl_mac').value; const rule_id = document.getElementById('acl_id').value;
        if(!mac) return alert("è¯·è¾“å…¥ MAC åœ°å€"); await apiCall('/add_acl', {mac, rule_id}); loadAcl();
    }
    async function delAcl(id) { if(confirm(`ç¡®å®šåˆ é™¤è§„åˆ™ ID ${id} å—?`)) { await apiCall('/del_acl', {rule_id: id}); loadAcl(); } }
</script>
</body>
</html>